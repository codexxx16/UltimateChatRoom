<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ChatRoom Pro — Realtime</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
<style>
  /* ---------- Base / Theme ---------- */
  *{box-sizing:border-box}
  :root{
    --primary:#6e8efb; --secondary:#a777e3;
    --bg:#0f1220; --panel:#141937; --soft:#1b2150;
    --text:#e9ecff; --muted:#aab1d9; --line:#28306a;
    --success:#2ecc71; --danger:#e74c3c; --warning:#f39c12; --info:#3498db;
    --white:#fff;
  }
  [data-theme="light"]{
    --bg:#f5f7ff; --panel:#ffffff; --soft:#eef2ff;
    --text:#1d2340; --muted:#6471a0; --line:#e5e9ff;
  }
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(135deg,var(--primary),var(--secondary));
    display:flex; align-items:center; justify-content:center; padding:14px; font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
  }

  /* ---------- App Shell ---------- */
  .app{
    width:100%; max-width:1200px; height:92vh; background:var(--panel);
    border-radius:20px; overflow:hidden; box-shadow:0 20px 50px rgba(0,0,0,.25);
    display:grid; grid-template-columns: 290px 1fr; grid-template-rows:64px 1fr;
    border:1px solid rgba(255,255,255,.06);
  }
  header{
    grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; padding:0 16px;
    background:linear-gradient(180deg,rgba(255,255,255,.06),transparent);
    border-bottom:1px solid rgba(255,255,255,.08); color:var(--white);
  }
  .brand{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.3px}
  .brand i{color:#ffd56b}
  .hdr-actions{display:flex; align-items:center; gap:8px}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:var(--soft); color:var(--text); border:1px solid var(--line); font-size:13px}
  .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--line);
    background:var(--soft); color:var(--text); cursor:pointer; font-weight:600; transition:.18s ease;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.18)}
  .btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary)); border-color:transparent; color:#fff}
  .btn-danger{background:linear-gradient(135deg,#ff6b6b,#d94141); border-color:transparent; color:#fff}

  /* ---------- Sidebar ---------- */
  .sidebar{
    border-right:1px solid var(--line); background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);
    padding:14px; display:flex; flex-direction:column; gap:14px; overflow:auto;
  }
  .search{position:relative}
  .search input{
    width:100%; background:var(--soft); color:var(--text); border:1px solid var(--line); outline:none;
    border-radius:12px; padding:12px 36px 12px 40px;
  }
  .search i{position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--muted)}
  .group-label{font-size:12px; color:var(--muted); letter-spacing:.2px; padding:0 4px}
  .list{background:var(--soft); border:1px solid var(--line); border-radius:14px; overflow:hidden}
  .item{display:flex; align-items:center; gap:12px; padding:12px; color:var(--text); cursor:pointer; border-bottom:1px dashed var(--line)}
  .item:last-child{border-bottom:none}
  .item:hover{background:rgba(255,255,255,.04)}
  .item.active{background:linear-gradient(90deg,rgba(110,142,251,.15),transparent)}
  .item .pill{margin-left:auto; background:rgba(255,255,255,.08); border:1px solid var(--line); border-radius:999px; padding:4px 8px; font-size:12px; color:var(--muted)}
  .avatar{width:28px; height:28px; border-radius:50%; background:linear-gradient(135deg,var(--primary),var(--secondary)); display:inline-grid; place-items:center; color:#fff; font-size:12px; font-weight:800}
  .presence{width:10px; height:10px; border-radius:50%; background:var(--success); border:2px solid var(--panel)}
  .presence.off{background:#8690c7}

  .rooms-actions{display:flex; gap:8px; margin-top:8px}
  .input{background:var(--soft); color:var(--text); border:1px solid var(--line); border-radius:12px; padding:10px 12px; outline:none}

  /* ---------- Main (Screens) ---------- */
  .main{display:flex; flex-direction:column; overflow:hidden}
  .tabs{display:flex; border-bottom:1px solid var(--line); background:linear-gradient(180deg,rgba(255,255,255,.03),transparent)}
  .tab{flex:1; text-align:center; padding:12px; cursor:pointer; color:var(--muted); font-weight:700; letter-spacing:.2px; border-bottom:3px solid transparent}
  .tab i{margin-right:8px}
  .tab.active{color:var(--text); border-color:var(--primary); background:rgba(110,142,251,.08)}
  .screen{display:none; height:100%; overflow:auto; padding:14px}
  .screen.active{display:block}

  /* ---------- Chat ---------- */
  .chat-wrap{display:grid; grid-template-rows: 1fr auto; height:calc(100% - 0px)}
  .msgs{
    background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:16px; overflow:auto;
  }
  .bubble{max-width:70%; margin:8px 0; padding:12px 14px; border-radius:14px; position:relative; background:var(--soft); color:var(--text); border:1px solid var(--line)}
  .bubble.me{margin-left:auto; background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; border-color:transparent}
  .meta{display:flex; align-items:center; gap:10px; font-size:12px; color:var(--muted); margin-bottom:6px}
  .from{font-weight:700}
  .ai .bubble{background:linear-gradient(135deg,#a777e3,#6e8efb); color:#fff; border-color:transparent}
  .typing{display:flex; align-items:center; gap:6px; color:var(--muted); font-size:13px; margin-top:6px}
  .typing .dot{width:6px; height:6px; border-radius:50%; background:var(--muted); animation:blink 1s infinite}
  .typing .dot:nth-child(2){animation-delay:.15s}
  .typing .dot:nth-child(3){animation-delay:.3s}
  @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}

  .composer{
    display:flex; gap:10px; padding:12px; background:linear-gradient(180deg,rgba(255,255,255,.03),transparent);
    border-top:1px solid var(--line);
  }
  .composer input{flex:1} .composer .input{padding:12px 14px}
  .composer .btn{padding:12px 14px}

  /* ---------- Users / Activity / Profile ---------- */
  .cards{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px}
  .card{background:var(--soft); border:1px solid var(--line); border-radius:16px; padding:14px}
  .row{display:flex; align-items:center; gap:10px}
  .sub{font-size:12px; color:var(--muted)}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--line); font-size:12px; color:var(--muted)}

  /* ---------- Auth Screen ---------- */
  .auth{
    position:absolute; inset:0; display:grid; place-items:center;
    background:radial-gradient(1000px 500px at 90% -20%, rgba(255,255,255,.12), transparent 50%), linear-gradient(135deg,rgba(255,255,255,.08),transparent 40%);
    backdrop-filter: blur(4px);
  }
  .auth-card{
    width:min(460px,92vw); background:var(--panel); border:1px solid var(--line); border-radius:20px; padding:20px;
    box-shadow:0 10px 40px rgba(0,0,0,.25); color:var(--text)
  }
  .auth-title{display:flex; align-items:center; gap:10px; font-size:22px; font-weight:800; margin-bottom:10px}
  .stack{display:grid; gap:10px; margin-top:10px}
  .hint{font-size:12px; color:var(--muted); margin-top:6px}
  .footer-note{margin-top:12px; display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px}

  /* ---------- Toast ---------- */
  .toast{position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:var(--soft); color:var(--text); border:1px solid var(--line); padding:12px 16px; border-radius:12px; display:none}
  .toast.show{display:block; animation: toast .2s ease-out}
  @keyframes toast{from{opacity:0; transform:translate(-50%,10px)}to{opacity:1; transform:translate(-50%,0)}}

  /* ---------- Responsive ---------- */
  @media (max-width: 950px){
    .app{grid-template-columns: 1fr; grid-template-rows:64px auto 1fr}
    .sidebar{grid-row:2; border-right:none; border-bottom:1px solid var(--line)}
  }
</style>
</head>
<body data-theme="dark">

<div class="app" id="app">
  <header>
    <div class="brand">
      <i class="fa-solid fa-message"></i> <span>ChatRoom Pro</span>
      <span class="badge" id="roomBadge"><i class="fa-solid fa-hashtag"></i><span id="currentRoomName">general</span></span>
    </div>
    <div class="hdr-actions">
      <span class="chip" title="Online users"><i class="fa-solid fa-users"></i> <span id="onlineCount">0</span></span>
      <button class="btn" id="themeToggle" title="Toggle theme"><i class="fa-solid fa-circle-half-stroke"></i></button>
      <button class="btn btn-danger" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="search">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input id="searchGlobal" class="input" placeholder="Search people, rooms, messages..." />
    </div>

    <div>
      <div class="group-label">Rooms</div>
      <div class="list" id="roomsList">
        <!-- Rooms populated here -->
      </div>
      <div class="rooms-actions">
        <input class="input" id="newRoomName" placeholder="New room name"/>
        <button class="btn btn-primary" id="addRoomBtn"><i class="fa-solid fa-plus"></i> Create</button>
      </div>
    </div>

    <div>
      <div class="group-label">Online</div>
      <div class="list" id="onlineList">
        <!-- Online users -->
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="tabs" id="tabs">
      <div class="tab active" data-screen="chatScreen"><i class="fa-solid fa-comments"></i> Chat</div>
      <div class="tab" data-screen="aiScreen"><i class="fa-solid fa-robot"></i> AI Assistant</div>
      <div class="tab" data-screen="usersScreen"><i class="fa-solid fa-user-group"></i> Users</div>
      <div class="tab" data-screen="activityScreen"><i class="fa-solid fa-bolt"></i> Activity</div>
      <div class="tab" data-screen="profileScreen"><i class="fa-solid fa-user"></i> Profile</div>
    </div>

    <!-- Chat Screen -->
    <section class="screen active" id="chatScreen">
      <div class="chat-wrap">
        <div class="msgs" id="chatMessages"></div>
        <div class="typing" id="typingArea" style="display:none;">
          <span id="typingName">Someone</span> is typing <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
        <div class="composer">
          <input class="input" id="messageInput" placeholder="Type a message and hit Enter…"/>
          <button class="btn" id="fileBtn" title="(demo only) attach file"><i class="fa-regular fa-file"></i></button>
          <button class="btn btn-primary" id="sendBtn"><i class="fa-solid fa-paper-plane"></i> Send</button>
        </div>
      </div>
    </section>

    <!-- AI Screen -->
    <section class="screen" id="aiScreen">
      <div class="chat-wrap">
        <div class="msgs" id="aiMessages"></div>
        <div class="composer">
          <input class="input" id="aiInput" placeholder="Ask the AI anything…"/>
          <button class="btn btn-primary" id="askAiBtn"><i class="fa-solid fa-wand-magic-sparkles"></i> Ask</button>
        </div>
      </div>
    </section>

    <!-- Users Screen -->
    <section class="screen" id="usersScreen">
      <div class="cards" id="usersGrid"></div>
    </section>

    <!-- Activity Screen -->
    <section class="screen" id="activityScreen">
      <div class="cards" id="activityGrid"></div>
    </section>

    <!-- Profile Screen -->
    <section class="screen" id="profileScreen">
      <div class="card">
        <div class="row" style="gap:14px">
          <div class="avatar" id="meAvatar">ME</div>
          <div>
            <div id="meEmail" style="font-weight:800"></div>
            <div class="sub">User ID: <span id="meUid"></span></div>
          </div>
        </div>
        <div class="hint" style="margin-top:10px">Presence is updated in real-time. Closing the tab will set you offline and record your last seen.</div>
        <div style="margin-top:12px; display:flex; gap:8px">
          <button class="btn" id="copyUid"><i class="fa-regular fa-copy"></i> Copy UID</button>
          <button class="btn" id="switchRoomGeneral"><i class="fa-solid fa-hashtag"></i> Go to #general</button>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Auth Overlay -->
<div class="auth" id="authScreen">
  <div class="auth-card">
    <div class="auth-title"><i class="fa-solid fa-comments"></i> ChatRoom Pro</div>
    <div class="sub">Connect with people & AI — fast, secure, real-time.</div>
    <div class="stack">
      <label>Email</label>
      <input class="input" type="email" id="email" placeholder="you@example.com"/>
      <label>Password</label>
      <input class="input" type="password" id="password" placeholder="Enter password"/>
      <button class="btn btn-primary" id="loginBtn"><i class="fa-solid fa-right-to-bracket"></i> Login / Sign up</button>
      <div id="loginMsg" class="hint"></div>
    </div>
    <div class="footer-note">
      <span>Tip: accounts are created automatically on first login.</span>
      <span id="authTheme" style="cursor:pointer"><i class="fa-solid fa-circle-half-stroke"></i> Theme</span>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase + App -->
<script type="module">
  /* ---------------- Firebase SDK (modular) ---------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-analytics.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
  import { getDatabase, ref, push, set, onChildAdded, onValue, serverTimestamp, onDisconnect, update, orderByChild, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

  /* ---------------- Config ---------------- */
  const firebaseConfig = {
    apiKey: "AIzaSyDXlJMf21zKgyBK1_0w38A2ne__cAbyxPU",
    authDomain: "chatroomai-333ed.firebaseapp.com",
    projectId: "chatroomai-333ed",
    storageBucket: "chatroomai-333ed.firebasestorage.app",
    messagingSenderId: "409648887637",
    appId: "1:409648887637:web:8f2af3540d65c79264e1dc",
    measurementId: "G-BV4JE727E3",
    databaseURL: "https://chatroomai-333ed-default-rtdb.firebaseio.com"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app) } catch(e) {} // Ignore analytics errors on http

  const auth = getAuth(app);
  const db   = getDatabase(app);

  /* ---------------- DOM ---------------- */
  const authScreen   = document.getElementById("authScreen");
  const emailEl      = document.getElementById("email");
  const passwordEl   = document.getElementById("password");
  const loginBtn     = document.getElementById("loginBtn");
  const loginMsg     = document.getElementById("loginMsg");

  const appShell     = document.getElementById("app");
  const logoutBtn    = document.getElementById("logoutBtn");
  const onlineCount  = document.getElementById("onlineCount");
  const roomsList    = document.getElementById("roomsList");
  const onlineList   = document.getElementById("onlineList");
  const searchGlobal = document.getElementById("searchGlobal");
  const newRoomName  = document.getElementById("newRoomName");
  const addRoomBtn   = document.getElementById("addRoomBtn");

  const tabs         = document.getElementById("tabs");
  const chatMessages = document.getElementById("chatMessages");
  const typingArea   = document.getElementById("typingArea");
  const typingName   = document.getElementById("typingName");
  const messageInput = document.getElementById("messageInput");
  const sendBtn      = document.getElementById("sendBtn");
  const aiMessages   = document.getElementById("aiMessages");
  const aiInput      = document.getElementById("aiInput");
  const askAiBtn     = document.getElementById("askAiBtn");
  const usersGrid    = document.getElementById("usersGrid");
  const activityGrid = document.getElementById("activityGrid");

  const currentRoomNameEl = document.getElementById("currentRoomName");
  const toastEl      = document.getElementById("toast");
  const themeToggle  = document.getElementById("themeToggle");
  const authTheme    = document.getElementById("authTheme");

  const meAvatar     = document.getElementById("meAvatar");
  const meEmail      = document.getElementById("meEmail");
  const meUid        = document.getElementById("meUid");
  const copyUid      = document.getElementById("copyUid");
  const switchRoomGeneral = document.getElementById("switchRoomGeneral");

  /* ---------------- State ---------------- */
  let currentUser = null;
  let unsubRooms  = null;
  let unsubUsers  = null;
  let unsubMsgs   = null;
  let unsubTyping = null;
  let currentRoom = "general";
  let typingTimer = null;

  const GEMINI_KEY = "AIzaSyAXd4GeRen6mBCQViRzxjFOsOkoFq_wN78"; // Provided by you
  const GEMINI_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta2/models/text-bison-001:generateText"; 
  // Note: For production, route this via a server to protect the key.

  /* ---------------- Utils ---------------- */
  const $ = (sel)=>document.querySelector(sel);
  function showToast(msg){ toastEl.textContent = msg; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"), 2200); }
  function initialsFromEmail(email){ return (email||"?").split("@")[0].slice(0,2).toUpperCase() }
  function timeStr(ts){ const d = new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
  function switchTheme(){ const root = document.body; root.dataset.theme = (root.dataset.theme === "dark" ? "light" : "dark"); localStorage.setItem("theme", root.dataset.theme); }
  (function bootTheme(){ const t = localStorage.getItem("theme"); if(t){ document.body.dataset.theme = t } })();

  themeToggle.addEventListener("click", switchTheme);
  authTheme.addEventListener("click", switchTheme);

  /* ---------------- Auth ---------------- */
  loginBtn.addEventListener("click", async ()=>{
    const email = (emailEl.value||"").trim();
    const pass  = (passwordEl.value||"").trim();
    loginMsg.textContent = "";
    if(!email || !pass){ loginMsg.textContent = "Please fill both fields."; return; }
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(err){
      if(err.code === "auth/user-not-found"){
        try{
          await createUserWithEmailAndPassword(auth, email, pass);
        }catch(e){ loginMsg.textContent = e.message; }
      }else{
        loginMsg.textContent = err.message;
      }
    }
  });

  logoutBtn.addEventListener("click", ()=> signOut(auth));

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      currentUser = user;
      // Presence
      const uref = ref(db, "users/"+user.uid);
      await update(uref, { email:user.email, online:true, lastSeen: serverTimestamp() });
      onDisconnect(uref).update({ online:false, lastSeen: serverTimestamp() });

      authScreen.style.display = "none";
      appShell.style.pointerEvents = "auto";

      meAvatar.textContent = initialsFromEmail(user.email);
      meEmail.textContent  = user.email;
      meUid.textContent    = user.uid;

      initRealtime();
      showToast("Welcome, " + (user.email||""));

    }else{
      currentUser = null;
      authScreen.style.display = "grid";
      appShell.style.pointerEvents = "none";
      chatMessages.innerHTML = "";
      aiMessages.innerHTML   = "";
      usersGrid.innerHTML    = "";
      activityGrid.innerHTML = "";
      if(unsubRooms) unsubRooms(); if(unsubUsers) unsubUsers(); if(unsubMsgs) unsubMsgs(); if(unsubTyping) unsubTyping();
    }
  });

  copyUid.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(meUid.textContent); showToast("UID copied"); }catch(e){}
  });
  switchRoomGeneral.addEventListener("click", ()=> selectRoom("general"));

  /* ---------------- Tabs ---------------- */
  tabs.addEventListener("click",(e)=>{
    const tab = e.target.closest(".tab"); if(!tab) return;
    [...tabs.children].forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    const scr = tab.dataset.screen;
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.getElementById(scr).classList.add("active");
  });

  /* ---------------- Rooms ---------------- */
  addRoomBtn.addEventListener("click", async ()=>{
    const name = (newRoomName.value||"").trim().toLowerCase().replace(/\s+/g,"-");
    if(!name) return;
    await set(ref(db,"rooms/"+name), { createdAt: serverTimestamp(), createdBy: currentUser.uid });
    newRoomName.value = "";
    showToast("Room #"+name+" created");
  });

  function selectRoom(room){
    currentRoom = room;
    currentRoomNameEl.textContent = room;
    // Update active class in sidebar
    [...roomsList.children].forEach(n=>n.classList.toggle("active", n.dataset.room===room));
    // Rewire listeners for messages & typing
    if(unsubMsgs) unsubMsgs();
    if(unsubTyping) unsubTyping();
    bindMessages(room);
    bindTyping(room);
    // Switch to chat tab
    [...tabs.children].forEach(t=> t.dataset.screen==="chatScreen" ? t.classList.add("active") : t.classList.remove("active"));
    document.querySelectorAll(".screen").forEach(s=> s.id==="chatScreen" ? s.classList.add("active") : s.classList.remove("active"));
  }

  function renderRoomsList(rooms){
    roomsList.innerHTML = "";
    const names = Object.keys(rooms||{}).sort((a,b)=> a.localeCompare(b));
    if(!names.includes("general")) names.unshift("general");
    names.forEach(name=>{
      const totalRef = ref(db, `rooms/${name}/meta/total`);
      const node = document.createElement("div");
      node.className = "item" + (name===currentRoom ? " active":"");
      node.dataset.room = name;
      node.innerHTML = `
        <div class="avatar">#</div>
        <div>
          <div style="font-weight:800">#${name}</div>
          <div class="sub">Room</div>
        </div>
        <div class="pill" data-pill="${name}">0</div>
      `;
      node.addEventListener("click", ()=> selectRoom(name));
      roomsList.appendChild(node);

      // live count of recent messages
      onValue(totalRef, snap=>{
        const v = snap.val()||0;
        const pill = roomsList.querySelector(`[data-pill="${name}"]`);
        if(pill) pill.textContent = v;
      });
    });
  }

  function initRealtime(){
    // Rooms stream
    const rRef = ref(db,"rooms");
    if(unsubRooms) unsubRooms();
    unsubRooms = onValue(rRef, snap=> renderRoomsList(snap.val()||{}));

    // Users stream + online count
    const uRef = ref(db,"users");
    if(unsubUsers) unsubUsers();
    unsubUsers = onValue(uRef, snap=>{
      const users = snap.val()||{};
      const entries = Object.entries(users);
      const online = entries.filter(([id,u])=>u.online).length;
      onlineCount.textContent = online;

      // Sidebar online list
      onlineList.innerHTML = "";
      entries.sort((a,b)=> (b[1].online?1:0)-(a[1].online?1:0) || (a[1].email||"").localeCompare(b[1].email||""));
      entries.forEach(([uid,u])=>{
        const li = document.createElement("div");
        li.className = "item";
        li.innerHTML = `
          <div class="avatar">${initialsFromEmail(u.email)}</div>
          <div>
            <div style="font-weight:800">${u.email||uid}</div>
            <div class="sub">${u.online ? "Online" : ("Last seen " + timeStr(u.lastSeen||Date.now()))}</div>
          </div>
          <div class="presence ${u.online?"":"off"}"></div>
        `;
        onlineList.appendChild(li);
      });

      // Users screen
      usersGrid.innerHTML = "";
      entries.forEach(([uid,u])=>{
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="row">
            <div class="avatar">${initialsFromEmail(u.email)}</div>
            <div>
              <div style="font-weight:800">${u.email||uid}</div>
              <div class="sub">${u.online ? "Online" : ("Last seen "+timeStr(u.lastSeen||Date.now()))}</div>
            </div>
          </div>
        `;
        usersGrid.appendChild(card);
      });
    });

    // Activity feed (last 20 messages across rooms)
    const allQuery = query(ref(db,"activity"), orderByChild("timestamp"), limitToLast(20));
    onValue(allQuery, snap=>{
      const data = snap.val()||{};
      const arr = Object.values(data).sort((a,b)=> (a.timestamp||0)-(b.timestamp||0));
      activityGrid.innerHTML = "";
      arr.reverse().forEach(ev=>{
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div class="row"><div class="avatar">${ev.room? ev.room[0].toUpperCase() : "A"}</div>
              <div>
                <div style="font-weight:800">${ev.room ? "#"+ev.room : "activity"}</div>
                <div class="sub">${timeStr(ev.timestamp)}</div>
              </div>
            </div>
            <span class="badge"><i class="fa-regular fa-user"></i> ${ev.sender}</span>
          </div>
          <div style="margin-top:8px">${escapeHtml(ev.text||"")}</div>
        `;
        activityGrid.appendChild(card);
      });
    });

    // Bind default room
    selectRoom("general");
  }

  /* ---------------- Messages ---------------- */
  function bindMessages(room){
    chatMessages.innerHTML = "";
    const msgQuery = query(ref(db, `rooms/${room}/messages`), orderByChild("timestamp"), limitToLast(100));
    unsubMsgs = onChildAdded(msgQuery, snap=>{
      const msg = snap.val();
      appendMessage(chatMessages, msg, msg.sender === (currentUser?.email), msg.sender==="AI");
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  }

  function appendMessage(container, msg, isMe=false, isAI=false){
    const wrap = document.createElement("div");
    wrap.className = "msg" + (isAI? " ai" : "");
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `<span class="from">${isAI ? "AI" : (msg.sender||"User")}</span> <span class="sub">${timeStr(msg.timestamp||Date.now())}</span>`;
    const bubble = document.createElement("div");
    bubble.className = "bubble"+(isMe?" me":"");
    bubble.textContent = msg.text||"";
    wrap.appendChild(meta); wrap.appendChild(bubble);
    container.appendChild(wrap);
  }

  function incrementRoomCounter(room){
    const mref = ref(db, `rooms/${room}/meta`);
    update(mref, { total: (serverTimestamp()) }); // placeholder write to trigger onValue
    // We'll also mirror into /activity for global feed
  }

  /* ---------------- Typing ---------------- */
  function bindTyping(room){
    const tref = ref(db, `rooms/${room}/typing`);
    unsubTyping = onValue(tref, snap=>{
      const who = snap.val()||{};
      const others = Object.entries(who).filter(([uid,v])=> uid !== (currentUser?.uid) && v === true).map(([uid])=>uid);
      if(others.length){
        typingArea.style.display = "flex";
        typingName.textContent = "Someone";
      }else{
        typingArea.style.display = "none";
      }
    });
  }
  function setTyping(room, val){
    if(!currentUser) return;
    update(ref(db, `rooms/${room}/typing`), { [currentUser.uid]: val });
  }
  messageInput.addEventListener("input", ()=>{
    setTyping(currentRoom, true);
    if(typingTimer) clearTimeout(typingTimer);
    typingTimer = setTimeout(()=> setTyping(currentRoom,false), 1300);
  });

  /* ---------------- Send Message ---------------- */
  sendBtn.addEventListener("click", sendMessage);
  messageInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendMessage(); } });

  async function sendMessage(){
    const text = (messageInput.value||"").trim();
    if(!text || !currentUser) return;
    const payload = {
      sender: currentUser.email,
      text,
      timestamp: Date.now()
    };
    const msgRef = push(ref(db, `rooms/${currentRoom}/messages`));
    await set(msgRef, payload);
    // Activity mirror
    const actRef = push(ref(db, "activity"));
    await set(actRef, { room: currentRoom, ...payload });
    messageInput.value = "";
    setTyping(currentRoom,false);
  }

  /* ---------------- AI Assistant ---------------- */
  askAiBtn.addEventListener("click", askAI);
  aiInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); askAI(); } });

  async function askAI(){
    const text = (aiInput.value||"").trim();
    if(!text) return;
    // Echo my prompt in AI panel
    appendMessage(aiMessages,{sender:currentUser?.email, text, timestamp: Date.now()}, true, false);
    aiInput.value = "";
    aiMessages.scrollTop = aiMessages.scrollHeight;

    // Call PaLM text-bison (per your key). Using x-goog-api-key header (correct for this API).
    try{
      const resp = await fetch(`${GEMINI_ENDPOINT}?key=${encodeURIComponent(GEMINI_KEY)}`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          prompt: { text },
          temperature: 0.7,
          maxOutputTokens: 256
        })
      });
      const data = await resp.json();
      const aiText = data?.candidates?.[0]?.output || "Sorry, I couldn't respond.";
      // Show in AI panel
      appendMessage(aiMessages,{sender:"AI", text: aiText, timestamp: Date.now()}, false, true);
      aiMessages.scrollTop = aiMessages.scrollHeight;

      // Also drop AI reply into current chat room
      const msgRef = push(ref(db, `rooms/${currentRoom}/messages`));
      await set(msgRef, { sender:"AI", text: aiText, timestamp: Date.now() });
      const actRef = push(ref(db, "activity"));
      await set(actRef, { room: currentRoom, sender:"AI", text: aiText, timestamp: Date.now() });

    }catch(err){
      appendMessage(aiMessages,{sender:"AI", text:"(Network error talking to AI)", timestamp: Date.now()}, false, true);
      console.error(err);
    }
  }

  /* ---------------- Search (client-side filter demo) ---------------- */
  searchGlobal.addEventListener("input", ()=>{
    const q = searchGlobal.value.toLowerCase().trim();
    // Filter online list
    [...onlineList.children].forEach(el=>{
      const text = el.textContent.toLowerCase();
      el.style.display = text.includes(q) ? "" : "none";
    });
    // Filter rooms list
    [...roomsList.children].forEach(el=>{
      const text = el.dataset.room?.toLowerCase() || "";
      el.style.display = text.includes(q) ? "" : "none";
    });
  });

  /* ---------------- Helpers ---------------- */
  function escapeHtml(str){
    return (str||"").replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[s]));
  }

  // Ensure “general” exists
  onValue(ref(db,"rooms/general"), async snap=>{
    if(!snap.exists()){
      await set(ref(db,"rooms/general"), { createdAt: serverTimestamp(), createdBy: "system" });
    }
  });

  // Simple “unread/total” emulation by writing a meta.timestamp on message add
  onChildAdded(ref(db, "activity"), (/*snap*/)=>{ /* side-effect already handled */ });

</script>
</body>
</html>
